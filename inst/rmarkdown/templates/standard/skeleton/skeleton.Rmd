---
title: "Assessment Template"
output: rmarkdown::html_vignette
editor_options: 
  chunk_output_type: console
vignette: >
  %\VignetteIndexEntry{Assessment Template}
  %\VignetteEncoding{UTF-8}  
  %\VignetteEngine{knitr::rmarkdown}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  echo = F
)
library(hera)
library(dplyr)
library(purrr)
library(tidyr)
library(tibble)
library(magrittr)
library(testthat)
library(visNetwork)
```

## Welcome

This document has been created following the generic [assessment guidance](https://ecodata1.github.io/hera/articles/development_guide.html).


## Details

<!-- Create a new regulatory assessment by changing the CAPITLIZE info below: -->

```{r setup}

standard <- tribble(
  ~question, ~response,
  "standard_short", "REPLACE_ME", 
  "parameter", "REPLACE_ME", 
  "status", "REPLACE_ME",
  "standard_long", "REPLACE_ME", 
  "standard_reference", "REPLACE_ME"
)


standard_format <- hera:::hera_format(standard = standard) # format assessment data
standard
```

## Data Sources

List of data sources. Can be demo data stored within package, web services or shared online file.

```{r}
sources <- tibble(
  data_sources = c(NA)
)
```

## Data

```{r data}
data <- tibble(
  parameter = NA,
  question = NA,
  response = NA,
  label = NA,
  sample_id = NA,
  location_id = NA,
  location_description = NA,
  grid_reference = NA,
  water_body_id = NA,
  year = NA,
  latitude = 0,
  longitude = 0,
  date_taken = NA,
  units = NA, 
  min = NA, 
  max = NA
)
data
```

## Locate

Metadata required about the location

```{r}
# A list of metadata for location of sampling
location <- data %>% select(
  location_id, # optional (recommended)
  location_description, 
  grid_reference
)
location <- location %>% unique()
head(location)
```

## Sample

Metadata required to assess each sample. (Excluding direct observations)

```{r}
# A list of questions and responses collected through observation
sample <- data %>% select(
  parameter,
  sample_id, # optional (recommended)
  date_taken
)
sample <- sample %>% unique()
head(sample)
```

## Observe

```{r}
questions <- data %>% select(
  question,
  response,
  label # optional (usually for taxonomic/species name)
)
questions
```


## Metrics

If applicable...

```{r indices}

indices_function <- function(data) {
  # Some calculated metric e.g. total responses in sample etc:
  
  data <- data %>%
    group_by(sample_id) %>% 
    summarise(question = "n_count",
              response = n(),
              sample_id = unique(sample_id)
              )
  
  return(data)
}
indexes <- indices_function(data)
indexes
```

## Predictors

```{r predictors}
predictors <- tibble(
   PREDICTOR_1 = NA,
   PREDICTOR_2 = NA,
   location_id = NA
  # ...
)

predictors <- pivot_longer(predictors, cols = names(predictors), names_to = "question", values_to = "response")

knitr::kable(predictors) 

```

## Predict

```{r prediction}
prediction_function <- function(predictors) {

  # Generates prediction based on predictors...
  prediction <- tibble(
    question = NA,
    response = NA,
    location_id = NA
  )

  return(prediction)
}
predictions <- prediction_function(predictors)
predictions
```

```{r together, echo=FALSE}

# All Together Now
sample_info <- data %>% 
  select(names(sample), names(location)) %>%
  unique()

if(!is.null(indexes)) {
indexes <- right_join(sample_info, indexes,
  by = c("sample_id" = "sample_id")
)
} else {
  indexes <- data
}

predictions <- right_join(sample_info, predictions,
  by = c("location_id" = "location_id")
)
predictions$response <- as.character(predictions$response)

combined_data <- bind_rows(questions, predictions, indexes)
```

## Assessment

```{r assessment_table}

assessment_table <- tibble(
  assessment = c( "high", 
                  "good", 
                  "moderate",
                  "poor",
                  "bad"),
  value = c(0.80,
            0.60,
            0.40,
            0.20,
            0)
  # ...
  # "red" = 0.33
  # "amber" = 0.5
  # "green" = 0.66
  # ...
  # "pass" = 0.5
  # "fail" = 0.0
)

assessment_table
```

## Assess

```{r assessment}
assessment_function <- function(data, assessment_table) {

  if (nrow(data %>%  filter(question == "MY_METRIC")) == 0) {
    return(NULL)
  }

  # Transform data -----------------------------------------------------------
  data <- data %>%
    select(.data$sample_id, .data$question, .data$response) %>%
    filter(.data$question %in% c("MY_PREDICTION",
                                 "MY_METRIC"))
  data$response <- as.numeric(data$response)

  data <- data %>%
    distinct() %>%
    group_by(.data$sample_id) %>%
    pivot_wider(names_from = .data$question, values_from = .data$response) %>%
    ungroup()
    data[is.na(data)] <- 0
  
  data$eqr <- data$MY_METRIC / data$MY_PREDICTION 
  
  class <- cut(data$eqr,
    breaks = c(1, assessment_table$value),
    labels = assessment_table$assesssment
  )

  assessments <- data.frame(
    sample_id = data$sample_id,
    class = class,
    eqr = data$eqr,
    status = data$status
  )

 assessments <- pivot_longer(assessments, -sample_id,
    names_to = "question", values_to = "response"
  )
    
  return(assessments)
}
assessments <- assessment_function(combined_data, assessment_table)
assessments
```

## Confidence

Confidence of assessment. 

```{r}

confidence_function <- function(data, aggregates = "sample_id") {

  confidence <- tibble(
    aggregates = NA,
    question = NA,
    response = NA
  )
  
  names(confidence)[1] <- aggregates[1]
  
}

```

## Data network

Display the interaction data and the steps in the network

```
network(catalogue)
```
## Checklist

```{r checklist}
check_list <- hera:::hera_test(standard = standard)
knitr::kable(check_list$standard_check)
```

## Update

```{r hera_update}
# No need to edit this code
update_catalogue(standard,
                 location,
                 sample,
                 indices_function,
                 prediction_function,
                 assessment_function,
                 confidence_function,
                 assessment_table,
                 indexes,
                 questions,
                 predictors,
                 assessments)

```

## Launch app

Below is an interactive application displaying the results of your assessment.

```{r launch_app, echo=FALSE, eval=FALSE}
# No need to edit this code
launch_app(new_catalogue = catalogue, data = data)

```
