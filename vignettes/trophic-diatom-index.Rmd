---
title: "Trophic Diatom Index"
output: rmarkdown::html_vignette
editor_options: 
  chunk_output_type: console
vignette: >
  %\VignetteIndexEntry{Trophic Diatom Index}
  %\VignetteEncoding{UTF-8}  
  %\VignetteEngine{knitr::rmarkdown}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  echo = F
)
library(hera)
library(dplyr)
library(purrr)
library(tidyr)
library(tibble)
library(magrittr)
library(testthat)
library(rlang)
library(visNetwork)
```

## Welcome

This document has been created following the generic [assessment guidance](https://ecodata1.github.io/hera/articles/development_guide.html).

## Details

```{r setup}

description <- tribble(
  ~question, ~response,
  "name_short", "TDI", 
  "name_long", "Trophic Diatom Index", 
  "parameter", "River Diatoms", 
  "status", "prototype"
)

```

## Data

Input data required for assessment. Can be from test data, real data or a short example.

```{r data}

data <- tribble(
  ~sample_id,
  ~question,
  ~response,
  ~label,
  ~parameter, 
  ~type,
  ~source,
  "235456",
  "Taxon abundance",
  "12",
  "Gomphonema olivaceum", 
  "River Diatoms",
  "input",
  "sepa_ecology_results"
)

```

## Assessment

Metric, prediction, classification, confidence calculation etc you wish to run.

### Calculation

Create a function to run your calculation.

```{r indices}

assessment_function <- function(data) {
  require(dplyr)
  require(tidyr)
  require(magrittr)
  require(tibble)
  
  darleq3_taxa <- darleq3::darleq3_taxa
  output <- filter(data, question == "Taxon abundance")
  output <- inner_join(output, darleq3_taxa, by = c("label" = "TaxonName"))

  output <- output %>% group_by(sample_id) %>% 
      mutate("total_count" = sum(as.numeric(response)))
  
  # Group data to get TDI scores for each taxa
  output <- output %>% group_by(sample_id, label, total_count, Saline) %>% 
    summarise("TDI" = (total_count / 100 * as.numeric(response)) * TDI4)
  
  # Mean TDI scores for each taxa and work out percentage for other metrics
  output <- output %>% group_by(sample_id, total_count) %>% 
              summarise( question = c("TDI4",
                                      "Saline"),
                         "response" = c(mean(TDI, na.rm =T ),
                                        unique(total_count) / 100 * sum(Saline))
                         )
  output <- ungroup(output)
  output <- output %>% select(-total_count)

  return(output)
}
output <- assessment_function(data)
```

## Check

```{r checklist}
standard_format <- hera:::hera_format(description = description) # format details
check_list <- hera:::hera_test(description = description) # test details data
knitr::kable(check_list$standard_check)
```

## Update

```{r hera_update}
# No need to edit this code
hera:::update_catalogue(description = description,
                        data = data,
                        assessment_function = assessment_function,
                        output = output
                        )
```


## Hera

This section tests if this assessment is usable using `hera` function


```{r}

hera(hera::demo_data)
assessment(data = hera::demo_data, name = "Trophic Diatom Index")
```


## Launch app

Below is an interactive application displaying the results of your assessment.

```{r launch_app, echo=FALSE, eval=FALSE}
# No need to edit this code
launch_app(new_catalogue = catalogue, data = data)

```
